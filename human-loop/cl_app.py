import streamlit as st
import pandas as pd
import io
from typing import Optional, Tuple

# Configuration de la page
st.set_page_config(
    page_title="üìÅ Workflow Sequential File Upload",
    page_icon="üîÑ",
    layout="wide"
)

# CSS personnalis√© pour am√©liorer l'interface
st.markdown("""
<style>
    .step-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px;
        border-radius: 10px;
        color: white;
        margin: 10px 0;
        text-align: center;
    }
    .step-completed {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        padding: 15px;
        border-radius: 10px;
        color: white;
        margin: 10px 0;
        text-align: center;
    }
    .step-pending {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        padding: 15px;
        border-radius: 10px;
        color: #6c757d;
        margin: 10px 0;
        text-align: center;
    }
    .file-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
    }
</style>
""", unsafe_allow_html=True)

def init_session_state():
    """Initialise l'√©tat de la session"""
    if 'workflow_step' not in st.session_state:
        st.session_state.workflow_step = 1
    
    if 'selected_region' not in st.session_state:
        st.session_state.selected_region = None
    
    if 'first_file_content' not in st.session_state:
        st.session_state.first_file_content = None
    
    if 'first_file_name' not in st.session_state:
        st.session_state.first_file_name = None
    
    if 'second_file_content' not in st.session_state:
        st.session_state.second_file_content = None
    
    if 'second_file_name' not in st.session_state:
        st.session_state.second_file_name = None
    
    if 'has_second_file' not in st.session_state:
        st.session_state.has_second_file = None
    
    if 'concatenated_content' not in st.session_state:
        st.session_state.concatenated_content = None

def read_file_content(uploaded_file) -> Optional[str]:
    """Lit le contenu d'un fichier upload√©"""
    try:
        if uploaded_file.type == "text/plain":
            # Fichier texte
            content = uploaded_file.read().decode('utf-8')
        elif uploaded_file.type == "text/csv":
            # Fichier CSV
            df = pd.read_csv(uploaded_file)
            content = df.to_string(index=False)
        elif uploaded_file.name.endswith('.sas'):
            # Fichier SAS
            content = uploaded_file.read().decode('utf-8')
        elif uploaded_file.name.endswith(('.py', '.sql', '.r')):
            # Autres fichiers de code
            content = uploaded_file.read().decode('utf-8')
        else:
            # Essayer de lire comme texte
            content = uploaded_file.read().decode('utf-8')
        
        return content
    except Exception as e:
        st.error(f"Erreur lors de la lecture du fichier: {str(e)}")
        return None

def display_workflow_progress():
    """Affiche la progression du workflow"""
    st.markdown("### üîÑ Progression du Workflow")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        if st.session_state.workflow_step >= 1:
            if st.session_state.selected_region:
                st.markdown('<div class="step-completed">‚úÖ √âtape 1: R√©gion s√©lectionn√©e</div>', unsafe_allow_html=True)
            else:
                st.markdown('<div class="step-container">1Ô∏è‚É£ S√©lection R√©gion</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="step-pending">1Ô∏è‚É£ S√©lection R√©gion</div>', unsafe_allow_html=True)
    
    with col2:
        if st.session_state.workflow_step >= 2:
            if st.session_state.first_file_content:
                st.markdown('<div class="step-completed">‚úÖ √âtape 2: Premier fichier</div>', unsafe_allow_html=True)
            else:
                st.markdown('<div class="step-container">2Ô∏è‚É£ Premier Fichier</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="step-pending">2Ô∏è‚É£ Premier Fichier</div>', unsafe_allow_html=True)
    
    with col3:
        if st.session_state.workflow_step >= 3:
            if st.session_state.has_second_file is not None:
                st.markdown('<div class="step-completed">‚úÖ √âtape 3: Choix second fichier</div>', unsafe_allow_html=True)
            else:
                st.markdown('<div class="step-container">3Ô∏è‚É£ Second Fichier?</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="step-pending">3Ô∏è‚É£ Second Fichier?</div>', unsafe_allow_html=True)
    
    with col4:
        if st.session_state.workflow_step >= 4:
            if st.session_state.concatenated_content:
                st.markdown('<div class="step-completed">‚úÖ √âtape 4: R√©sultat final</div>', unsafe_allow_html=True)
            else:
                st.markdown('<div class="step-container">4Ô∏è‚É£ R√©sultat Final</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="step-pending">4Ô∏è‚É£ R√©sultat Final</div>', unsafe_allow_html=True)

def step_1_region_selection():
    """√âtape 1: S√©lection de la r√©gion"""
    st.markdown("### üåç √âtape 1: S√©lection de la R√©gion")
    
    # S√©lecteur de r√©gion
    region_options = ["S√©lectionnez une r√©gion...", "nordics", "netherlands"]
    
    selected_region = st.selectbox(
        "Choisissez votre r√©gion:",
        options=region_options,
        index=0 if not st.session_state.selected_region else region_options.index(st.session_state.selected_region),
        key="region_selector"
    )
    
    # Validation et passage √† l'√©tape suivante
    if selected_region != "S√©lectionnez une r√©gion...":
        if st.button("‚úÖ Confirmer la r√©gion", type="primary"):
            st.session_state.selected_region = selected_region
            st.session_state.workflow_step = 2
            st.success(f"‚úÖ R√©gion s√©lectionn√©e: **{selected_region}**")
            st.rerun()
    else:
        st.info("üëÜ Veuillez s√©lectionner une r√©gion pour continuer")

def step_2_first_file_upload():
    """√âtape 2: Upload du premier fichier"""
    st.markdown("### üìÅ √âtape 2: Upload du Premier Fichier")
    
    # Afficher la r√©gion s√©lectionn√©e
    st.markdown(f'<div class="file-info">üåç <strong>R√©gion s√©lectionn√©e:</strong> {st.session_state.selected_region}</div>', unsafe_allow_html=True)
    
    # Upload du premier fichier
    first_file = st.file_uploader(
        "Uploadez votre premier fichier:",
        type=['txt', 'csv', 'sas', 'py', 'sql', 'r'],
        key="first_file_uploader"
    )
    
    if first_file is not None:
        # Lire le contenu du fichier
        file_content = read_file_content(first_file)
        
        if file_content:
            # Afficher les informations du fichier
            st.markdown("**üìÑ Informations du fichier:**")
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("Nom", first_file.name)
            with col2:
                st.metric("Taille", f"{first_file.size} bytes")
            with col3:
                st.metric("Type", first_file.type)
            
            # Aper√ßu du contenu
            with st.expander("üëÄ Aper√ßu du contenu"):
                st.text_area("Contenu du fichier:", file_content[:1000] + "..." if len(file_content) > 1000 else file_content, height=200, disabled=True)
            
            # Confirmer et passer √† l'√©tape suivante
            if st.button("‚úÖ Confirmer le premier fichier", type="primary"):
                st.session_state.first_file_content = file_content
                st.session_state.first_file_name = first_file.name
                st.session_state.workflow_step = 3
                st.success(f"‚úÖ Premier fichier trait√©: **{first_file.name}**")
                st.rerun()

def step_3_second_file_choice():
    """√âtape 3: Choix du second fichier"""
    st.markdown("### ü§î √âtape 3: Avez-vous un Second Fichier?")
    
    # R√©sum√© des √©tapes pr√©c√©dentes
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f'<div class="file-info">üåç <strong>R√©gion:</strong> {st.session_state.selected_region}</div>', unsafe_allow_html=True)
    with col2:
        st.markdown(f'<div class="file-info">üìÅ <strong>Premier fichier:</strong> {st.session_state.first_file_name}</div>', unsafe_allow_html=True)
    
    # Question sur le second fichier
    st.markdown("**Souhaitez-vous ajouter un second fichier pour concatener avec le premier?**")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("‚úÖ Oui, j'ai un second fichier", use_container_width=True, type="primary"):
            st.session_state.has_second_file = True
            st.session_state.workflow_step = 4
            st.rerun()
    
    with col2:
        if st.button("‚ùå Non, continuer avec un seul fichier", use_container_width=True):
            st.session_state.has_second_file = False
            # Directement finaliser avec un seul fichier
            st.session_state.concatenated_content = st.session_state.first_file_content
            st.session_state.workflow_step = 4
            st.rerun()

def step_4_second_file_upload_or_finalize():
    """√âtape 4: Upload du second fichier ou finalisation"""
    if st.session_state.has_second_file:
        st.markdown("### üìÅ √âtape 4: Upload du Second Fichier")
        
        # R√©sum√©
        st.markdown("**üìã R√©sum√© actuel:**")
        col1, col2, col3 = st.columns(3)
        with col1:
            st.markdown(f'<div class="file-info">üåç <strong>R√©gion:</strong> {st.session_state.selected_region}</div>', unsafe_allow_html=True)
        with col2:
            st.markdown(f'<div class="file-info">üìÅ <strong>Premier fichier:</strong> {st.session_state.first_file_name}</div>', unsafe_allow_html=True)
        with col3:
            st.markdown(f'<div class="file-info">üìä <strong>Caract√®res:</strong> {len(st.session_state.first_file_content)}</div>', unsafe_allow_html=True)
        
        # Upload du second fichier
        second_file = st.file_uploader(
            "Uploadez votre second fichier:",
            type=['txt', 'csv', 'sas', 'py', 'sql', 'r'],
            key="second_file_uploader"
        )
        
        if second_file is not None:
            # Lire le contenu du second fichier
            second_file_content = read_file_content(second_file)
            
            if second_file_content:
                # Afficher les informations du second fichier
                st.markdown("**üìÑ Informations du second fichier:**")
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("Nom", second_file.name)
                with col2:
                    st.metric("Taille", f"{second_file.size} bytes")
                with col3:
                    st.metric("Type", second_file.type)
                
                # Aper√ßu du contenu
                with st.expander("üëÄ Aper√ßu du contenu du second fichier"):
                    st.text_area("Contenu:", second_file_content[:1000] + "..." if len(second_file_content) > 1000 else second_file_content, height=200, disabled=True)
                
                # Confirmer et concatener
                if st.button("üîó Concatener les fichiers", type="primary"):
                    # Concatenation avec s√©parateur
                    separator = f"\n\n{'='*50}\nüìÅ FICHIER 2: {second_file.name}\n{'='*50}\n\n"
                    concatenated = f"üìÅ FICHIER 1: {st.session_state.first_file_name}\n{'='*50}\n\n{st.session_state.first_file_content}{separator}{second_file_content}"
                    
                    st.session_state.second_file_content = second_file_content
                    st.session_state.second_file_name = second_file.name
                    st.session_state.concatenated_content = concatenated
                    st.success("‚úÖ Fichiers concaten√©s avec succ√®s!")
                    st.rerun()
    
    # Affichage du r√©sultat final
    if st.session_state.concatenated_content:
        display_final_result()

def display_final_result():
    """Affiche le r√©sultat final"""
    st.markdown("### üéâ R√©sultat Final")
    
    # Statistiques finales
    st.markdown("**üìä Statistiques:**")
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("R√©gion", st.session_state.selected_region)
    with col2:
        st.metric("Fichiers trait√©s", "2" if st.session_state.second_file_content else "1")
    with col3:
        st.metric("Caract√®res totaux", len(st.session_state.concatenated_content))
    with col4:
        st.metric("Lignes totales", len(st.session_state.concatenated_content.split('\n')))
    
    # D√©tails des fichiers
    with st.expander("üìã D√©tails des fichiers trait√©s"):
        if st.session_state.first_file_name:
            st.write(f"**Premier fichier:** {st.session_state.first_file_name}")
        if st.session_state.second_file_name:
            st.write(f"**Second fichier:** {st.session_state.second_file_name}")
    
    # Contenu final
    st.markdown("**üìÑ Contenu Final (Concaten√©):**")
    st.text_area(
        "R√©sultat:", 
        st.session_state.concatenated_content, 
        height=400,
        key="final_content"
    )
    
    # Actions sur le r√©sultat
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("üìã Copier le contenu", use_container_width=True):
            st.write("Contenu pr√™t √† √™tre copi√©!")
    
    with col2:
        # Bouton de t√©l√©chargement
        filename = f"concatenated_{st.session_state.selected_region}_{len(st.session_state.concatenated_content)}_chars.txt"
        st.download_button(
            label="üíæ T√©l√©charger",
            data=st.session_state.concatenated_content,
            file_name=filename,
            mime="text/plain",
            use_container_width=True
        )
    
    with col3:
        if st.button("üîÑ Recommencer", use_container_width=True):
            # Reset complet
            for key in ['workflow_step', 'selected_region', 'first_file_content', 
                       'first_file_name', 'second_file_content', 'second_file_name', 
                       'has_second_file', 'concatenated_content']:
                if key in st.session_state:
                    del st.session_state[key]
            st.rerun()

def main():
    """Fonction principale"""
    init_session_state()
    
    st.title("üìÅ Workflow Sequential File Upload")
    st.markdown("---")
    
    # Affichage de la progression
    display_workflow_progress()
    st.markdown("---")
    
    # Navigation selon l'√©tape
    if st.session_state.workflow_step == 1:
        step_1_region_selection()
    
    elif st.session_state.workflow_step == 2:
        step_2_first_file_upload()
    
    elif st.session_state.workflow_step == 3:
        step_3_second_file_choice()
    
    elif st.session_state.workflow_step == 4:
        step_4_second_file_upload_or_finalize()
    
    # Sidebar avec informations
    with st.sidebar:
        st.header("üìä √âtat du Workflow")
        st.write(f"**√âtape actuelle:** {st.session_state.workflow_step}/4")
        
        if st.session_state.selected_region:
            st.success(f"üåç R√©gion: {st.session_state.selected_region}")
        
        if st.session_state.first_file_name:
            st.success(f"üìÅ Fichier 1: {st.session_state.first_file_name}")
        
        if st.session_state.second_file_name:
            st.success(f"üìÅ Fichier 2: {st.session_state.second_file_name}")
        
        st.markdown("---")
        st.markdown("**üîß Types de fichiers support√©s:**")
        st.markdown("- `.txt` - Fichiers texte")
        st.markdown("- `.csv` - Fichiers CSV")
        st.markdown("- `.sas` - Code SAS")  
        st.markdown("- `.py` - Code Python")
        st.markdown("- `.sql` - Requ√™tes SQL")
        st.markdown("- `.r` - Code R")

if __name__ == "__main__":
    main()